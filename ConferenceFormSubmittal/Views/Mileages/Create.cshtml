@model ConferenceFormSubmittal.Models.Mileage

@{
    ViewBag.Title = "Create";
}


<!--HEADING-->
<div class="row pt-3">
    <div class="col-12">
        <div class="card card-header bg-NCDSB-Grey">
            <h3 class="text-center font-weight-bold">Create Mileages</h3>
        </div>
    </div>
</div>



@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "frmCreateMileage" }))
{
    @Html.AntiForgeryToken()


 <div class="row pt-3">

        @*---------------- MILEAGE FORM ----------------------*@
     <div class="col-8">
         <div class="card bg-NCDSB-Grey">
             <div class="card-body ">


                 @*---------------------ROW------------------------------------------------------------------------------------*@
                 <div class="row pt-3">
                     <div class="col-1">
                         @Html.LabelFor(model => model.StartAddress, htmlAttributes: new { @class = "control-label font-weight-bold" })
                     </div>
                     <div class="col-3">
                         @Html.EditorFor(model => model.StartAddress, new { htmlAttributes = new { @class = "form-control d-block", @id = "txtStartAddress", @placeholder = "Enter an Address" } })
                         @Html.ValidationMessageFor(model => model.StartAddress, "", new { @class = "text-danger" })
                     </div>
                     <div class="col-2">
                         @Html.LabelFor(model => model.EndAddress, htmlAttributes: new { @class = "control-label font-weight-bold" })
                     </div>
                     <div class="col-3">
                         @Html.EditorFor(model => model.EndAddress, new { htmlAttributes = new { @class = "form-control", @id = "txtEndAddress", @placeholder = "Enter an Address" } })
                         @Html.ValidationMessageFor(model => model.EndAddress, "", new { @class = "text-danger" })
                     </div>
                     <div class="col-3">
                         <a onclick="GetRoute()" class="btn btn-primary d-block">
                             <i class="fa fa-map-marker fa-2x"></i>
                             Get Route
                         </a>
                     </div>
                 </div>

                 @*---------------------ROW------------------------------------------------------------------------------------*@
                 <div class="row pt-3">
                     <div class="col-1">
                         @Html.LabelFor(model => model.TravelDate, htmlAttributes: new { @class = "control-label font-weight-bold" })
                     </div>
                     <div class="col-3">
                         @Html.EditorFor(model => model.TravelDate, new { htmlAttributes = new { @class = "form-control", @id = "txtTravelDate" } })
                         @Html.ValidationMessageFor(model => model.TravelDate, "", new { @class = "text-danger" })
                     </div>
                     <div class="col-2">
                         <label class="font-weight-bold">Attach Application?@*Should be conference?*@ </label>
                     </div>
                     <div class="col-3">
                         @*this should actually display the conference name not the application rationale*@
                         @Html.DropDownList("ApplicationID", null, "None", htmlAttributes: new { @class = "form-control", @id = "ddlApplicationID" })
                     </div>
                     <div class="col-2">
                         @Html.LabelFor(model => model.RoundTrip, htmlAttributes: new { @class = "control-label font-weight-bold" })
                     </div>
                     <div class="col-1">
                         @Html.EditorFor(model => model.RoundTrip, new { htmlAttributes = new { @class = "form-control", @id = "chkRoundTrip" } })
                     </div>
                 </div>

                 @*---------------------ERROR MESSAGES ---------------------*@
                 <div class="row pt-3">
                     <div class="col-12">
                         <label id="txtValid" class="text-danger "> </label>
                     </div>
                 </div>
                 @*---------------------ERROR MESSAGES ---------------------*@

             </div>

             <div class="card-footer rgba-grey-light">
                 @*---------------------ROW------------------------------------------------------------------------------------*@
                 <div class="row pt-3 ">
                     <div class="col-2">
                         <label" class="font-weight-bold">Kilometers</label">
                     </div>
                     <div class="col-3">
                         @Html.EditorFor(model => model.Kilometres, new
                    {
                        htmlAttributes = new
                        {
                            @class = "form-control text-dark",
                            @id = "txtKilometres",
                            @disabled = "disabled"
                        }
                    })
                         @Html.ValidationMessageFor(model => model.Kilometres, "", new { @class = "text-danger" })
                     </div>
                     <div class="col-2">
                         <label class="font-weight-bold">Mileage Claim</label>
                     </div>
                     <div class="col-3">
                         <input class="form-control text-dark" type="text" id="txtReimbursement" disabled="disabled" />
                     </div>
                 </div>


                 <div class="row">
                     <div class="col-12">
                         <a onclick="addMileage()" class="btn btn-success mt-3 d-block">
                             @*<i class="fa fa-plus"></i>*@
                             <i class="fa fa-plus fa-2x" aria-hidden="true"></i>
                             Add to List
                         </a>
                         @Html.EditorFor(model => model.EmployeeID, new { htmlAttributes = new { @class = "form-control", @id = "txtEmployeeID", @Value = "1", @hidden = "hidden" } })
                         @Html.EditorFor(model => model.StatusID, new { htmlAttributes = new { @class = "form-control", @id = "txtStatusID", @Value = "1", @hidden = "hidden" } })
                     </div>
                 </div>
             </div>

         </div>
     </div>
        @*---------------- MILEAGE FORM ----------------------*@

        @*-------------------------  GOOGLE MAP Column ---------------*@
     <div class="col-4">
         <div class="card bg-NCDSB-Grey">
             <div class="card-body">
                 <div class="row">
                     <div class="col-12">
                         <div class="col-12" id="dvMap" style="min-height:400px"></div>
                     </div>
                 </div>
             </div>
         </div>
     </div>

    
</div>


    //-----Show items basket ----
    <div class="row pt-3">
        <div class="col-12">
            <div class="card bg-NCDSB-Grey">
                <div class="card-header">
                    <button id="btnSubmit" type="button" value="Submit" class="btn btn-primary float-right">
                        <i class="fa fa-paper-plane fa-2x"></i> Submit
                    </button>
                </div>
                <div class="card-body">
                    <table id="tblMileages" class="table">
                        <tbody>
                            <tr>
                                <th>
                                    @Html.LabelFor(model => model.TravelDate, htmlAttributes: new { @class = "control-label font-bold" })
                                </th>
                                <th>
                                    @Html.LabelFor(model => model.StartAddress, htmlAttributes: new { @class = "control-label font-bold" })
                                </th>
                                <th>
                                    @Html.LabelFor(model => model.EndAddress, htmlAttributes: new { @class = "control-label font-bold" })
                                </th>
                                <th>
                                    <b>Kilometres</b>
                                </th>
                                <th>
                                    <b>Attach Application?@*Should be conference?*@</b>
                                </th>
                                <th>
                                    @Html.LabelFor(model => model.RoundTrip, htmlAttributes: new { @class = "control-label font-bold" })
                                </th>
                                <th>
                                    <b class="d-block">Mileage Claim</b>
                                </th>
                                <th></th>
                            </tr>
                            <tr id="trAddMileage" class="flex-wrap">
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <button id="btnSubmit2" type="button" value="Submit" class="btn btn-primary float-right">
                        <i class="fa  fa-paper-plane fa-2x"></i> Submit
                    </button>
                </div>

            </div>


        </div>

   
    </div>


    
} @*-----------end of form ---------------*@





@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">

        function validMileage(travelDate, startAddress, endAddress, kilometres) {

            var result = true;
            var valid = $("#txtValid");
            valid.empty();

            if (travelDate == "") {
                result = false;
                valid.append("There must be a Travel Date.");
            }
            if (startAddress == "") {
                result = false;
                valid.append("There must be a Start Address.");
            }
            if (endAddress == "") {
                result = false;
                valid.append("There must be a End Address.");
            }
            if (typeof kilometres == 'number' || kilometres == "") {
                result = false;
                valid.append("There must be a Kilometre amount.");
            }

            return result;
        }

        // adds the mileage to the table if valid
        function addMileage() {

            // get values
            var $txtTravelDate = $("#txtTravelDate"),
                $txtStartAddress = $("#txtStartAddress"),
                $txtEndAddress = $("#txtEndAddress"),
                $txtKilometres = $("#txtKilometres"),
                $ddlAppID = $("#ddlApplicationID"),
                $chkRoundTrip = $("#chkRoundTrip"),
                $txtreimbursement = $("#txtReimbursement"),
                travelDate = $txtTravelDate.val(),
                startAddress = $txtStartAddress.val(),
                endAddress = $txtEndAddress.val(),
                kilometres = $txtKilometres.val(),
                app = $ddlAppID.find(":selected").val(),
                appID = $ddlAppID.val(),
                roundTrip = $chkRoundTrip.is(':checked'),
                roundTriptxt = roundTrip ? "Yes" : "No";
            reimbursement = $txtreimbursement.val();

            if (confirm("Do you want to add this Mileage Entry?")) {
                if (validMileage(travelDate, startAddress, endAddress, kilometres)) {
                    // add the expense to the table
                    $("#trAddMileage").before(
                        "<tr class='trMileage'>" +
                        "<td class='travelDate'>" + travelDate + "</td>" +
                        "<td class='startAddress'>" + startAddress + "</td>" +
                        "<td class='endAddress'>" + endAddress + "</td>" +
                        "<td class='kilometres' data-kilometres='" + kilometres + "' > " + kilometres + " km</td > " +
                        "<td class='applicationID' data-id='" + appID + "'>" + app + "</td>" +
                        "<td class='roundTrip' data-roundTrip='" + roundTrip + "' > " + roundTriptxt + "</td > " +
                        "<td class='reimbursement'>" + reimbursement + "</td>" +
                        "<td><a onclick='removeMileage($(this))' class='removeMileage btn btn-danger'><i class='fa fa-minus fa2x'></i> Remove </a></td> " +
                        "</tr>");

                    // clear the input fields
                    //$txtTravelDate.val("");
                    $txtStartAddress.val("");
                    $txtEndAddress.val("");
                    $txtKilometres.val("");
                    $chkRoundTrip.val("");
                    $txtreimbursement.val("");
                }
            }
        }

        // removes an expense from the table
        function removeMileage($row) {
            if (confirm("Do you want to delete this Mileage Entry?")) {
                $row.closest(".trMileage").remove();
            }
        }

        $("#btnSubmit").click(function () {

            var mileageBatch = [];

            if (confirm("Do you want to submit?")) {

                $(".trMileage").each(function () {
                    var row = $(this);

                    var mileage = {
                        TravelDate: row.find(".travelDate").html(),
                        StartAddress: row.find(".startAddress").html(),
                        EndAddress: row.find(".endAddress").html(),
                        Kilometres: row.find(".kilometres").data("kilometres"),
                        ApplicationID: row.find(".applicationID").data("id"),
                        RoundTrip: row.find(".roundTrip").data("roundTrip"),
                        StatusID: 1,
                        EmployeeID: 1 //needs to reference the logged in user
                    };

                    mileageBatch.push(mileage);
                });

                $.ajax({
                    type: "POST",
                    url: "/Mileages/AddMileages",
                    data: JSON.stringify(mileageBatch),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        //alert((response + 1) + " mileage(s) added.");
                        $("#frmCreateMileage").submit();
                    }
                });
            }
        });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQoBa1Dcsary4e_iMueoDfG8taMDb8IKI&libraries=places" type="text/javascript"></script>

    @*This script is the actual google api calculatin the distance and cost(with dummy rate) between two locations*@
    <script>

        var source, destination;
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();

        var map = new google.maps.Map(document.getElementById('dvMap'), {
            center: { lat: 43.002662, lng: -79.2554264 },
            zoom: 15,
            mapTypeId: 'roadmap'
        });

        google.maps.event.addDomListener(window, 'load', function () {
            new google.maps.places.SearchBox(document.getElementById('txtStartAddress'));
            new google.maps.places.SearchBox(document.getElementById('txtEndAddress'));
            directionsDisplay = new google.maps.DirectionsRenderer({ /*'draggable': true*/ });
        });

        function GetRoute() {

            directionsDisplay.setMap(map);

            source = document.getElementById("txtStartAddress").value;
            destination = document.getElementById("txtEndAddress").value;

            var request = {
                origin: source,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                }
            });

            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [source],
                destinations: [destination],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {

                if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                    var distance = response.rows[0].elements[0].distance.text;
                    var dvDistance = document.getElementById("txtKilometres");
                    //this will be changed from dvcost to Cost once the database supports it
                    var dvCost = document.getElementById("txtReimbursement");
                    //This is a dummy rate value for Cost per Km
                    var rate = 5;
                    //Converts the Distance from meters to kilometers
                    var distancecost = response.rows[0].elements[0].distance.value / 1000;
                    var cost = distancecost * rate;

                    dvDistance.value = distancecost.toFixed(2) + " km";
                    dvCost.value = "$" + cost.toFixed(2)

                } else {
                    alert("Unable to find the distance via road.");
                }
            });
        }

    </script>
}
